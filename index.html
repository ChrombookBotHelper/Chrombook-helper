<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Chrombook Helfer Bot ‚Äì v8 (DE/EN)</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    :root{--bg:#0b0f19;--panel:#121a2a;--panel2:#0f1726;--border:#20304e;--text:#e9eef7;--muted:#a3b0c7}
    *{box-sizing:border-box}html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 10% -10%,#1b2440 0,transparent 60%),var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,sans-serif}
    .app{max-width:980px;margin:auto;display:flex;flex-direction:column;min-height:100dvh;padding:12px}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(135deg,rgba(109,124,255,.25),rgba(0,212,255,.12)),var(--panel);border:1px solid var(--border);border-radius:14px;padding:8px 10px}
    .row{display:flex;align-items:center;gap:10px}.sp{flex:1}
    .logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit;user-select:none}
    .logo svg{width:32px;height:32px;border-radius:8px}.title{font-weight:700}
    button{font:inherit;color:var(--text);background:linear-gradient(180deg,#1b2440,#121a2a);border:1px solid var(--border);padding:10px 14px;border-radius:12px;cursor:pointer}
    button:hover{filter:brightness(1.06)}.ghost{background:transparent;border-color:var(--border)}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;display:inline-flex;align-items:center;gap:6px}
    .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}@media (min-width:680px){.cards{grid-template-columns:repeat(4,1fr)}}
    .card{border:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel2));border-radius:16px;padding:12px}
    .card h4{margin:0 0 6px;font-size:14px;color:#c9d7ff}.card p{margin:0 0 8px;font-size:13px;color:var(--muted)}
    .chatWrap{margin-top:10px;border:1px solid var(--border);border-radius:16px;background:linear-gradient(180deg,#0e152b,#0b1120)}
    .chatTabs{display:flex;gap:8px;padding:8px;border-bottom:1px solid var(--border)}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:linear-gradient(180deg,#121a2a,#0f1726);cursor:pointer;font-size:14px}
    .tab.active{outline:2px solid rgba(109,124,255,.5)}.modeInfo{margin-left:auto;font-size:12px;color:#a3b0c7;display:flex;align-items:center;gap:8px}
    .dot{width:8px;height:8px;border-radius:50%;background:#666;display:inline-block}.dot.live{background:#3ddc97;box-shadow:0 0 0 4px rgba(61,220,151,.12)}
    .chat{padding:12px;display:flex;flex-direction:column;gap:10px;min-height:44dvh}
    .msg{display:flex;gap:8px;align-items:flex-start}.msg .bubble{background:linear-gradient(180deg,#121a2a,#0f1726);border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px;line-height:1.4;white-space:pre-wrap}
    .msg.user .bubble{background:linear-gradient(180deg,#0f1524,#0a0f19)}.avatar{width:30px;height:30px;border-radius:50%;display:grid;place-items:center;background:radial-gradient(circle at 35% 35%,#9bb3ff,#6d7cff 40%,#0b0f19 70%);border:1px solid rgba(255,255,255,.12)}
    .composer{position:sticky;bottom:0;display:flex;gap:8px;border-top:1px solid var(--border);padding:8px;background:linear-gradient(180deg,#0b1120,#0b1120);border-radius:0 0 16px 16px}
    .composer input{flex:1;border:1px solid var(--border);border-radius:10px;padding:12px 12px;background:#0b1120;color:#e9eef7}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:rgba(0,0,0,.6);border:1px solid var(--border);padding:10px 12px;border-radius:12px;z-index:40}
    .fab{position:fixed;right:16px;bottom:84px;width:56px;height:56px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(135deg,rgba(109,124,255,.85),rgba(0,212,255,.65));border:1px solid rgba(255,255,255,.18);z-index:15}
    .badge{position:absolute;top:-6px;right:-6px;min-width:18px;height:18px;padding:0 5px;display:grid;place-items:center;background:#ff6b6b;color:#fff;border-radius:999px;font-size:11px;font-weight:700;border:1px solid rgba(255,255,255,.35)}
    .modal-backdrop{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:16px;background:rgba(0,0,0,.55);z-index:20}
    .modal{width:min(780px,96vw);background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:16px;padding:14px}
    .modal input,.modal textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1120;color:#e9eef7}
    .rowbtn{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}.hidden{display:none !important}.meta{font-size:12px;color:#a3b0c7}
    .ticket{border:1px solid var(--border);border-radius:12px;padding:10px;background:linear-gradient(180deg,#0f1526,#0c1222);margin-top:8px}
    .tag{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;color:#c9d7ff}
    .thread{max-height:38vh;overflow:auto;border:1px solid var(--border);border-radius:12px;padding:10px;background:linear-gradient(180deg,#0f1526,#0c1222)}
    .tmsg{display:flex;gap:8px;margin-bottom:8px}.tmsg .who{font-weight:700;font-size:12px;color:#c9d7ff;min-width:100px}.tmsg .txt{white-space:pre-wrap}.right{justify-content:flex-end}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="row">
        <a href="#" class="logo" id="logo" title="Chrombook Helfer">
          <svg viewBox="0 0 64 64" aria-hidden="true">
            <defs><radialGradient id="lg" cx="50%" cy="50%" r="70%"><stop offset="0%" stop-color="#cfe3ff"/><stop offset="40%" stop-color="#7ea3ff"/><stop offset="100%" stop-color="#0a0f1d"/></radialGradient></defs>
            <rect width="64" height="64" rx="12" fill="url(#lg)"/>
            <g opacity="0.9"><circle cx="16" cy="18" r="2" fill="white"/><circle cx="46" cy="14" r="1.2" fill="white"/><circle cx="40" cy="34" r="1.1" fill="white"/><circle cx="24" cy="48" r="1.2" fill="white"/></g>
            <path d="M10 50 Q32 30 54 50" stroke="#7ef3ff" stroke-width="2" fill="none" opacity="0.8"/>
          </svg>
          <div>
            <div class="title">Chrombook&nbsp;Helfer</div>
            <div class="meta">Galaxy ‚Ä¢ Dark</div>
          </div>
        </a>
        <div class="sp"></div>
        <span id="livePill" class="pill"><span class="dot" id="liveDot"></span><span id="modeLabel">Offline</span></span>
        <button id="langBtn" class="ghost" title="Sprache">DE ‚Ä¢ EN</button>
        <button id="contactBtn" title="Mitarbeiter kontaktieren">Kontakt ‚Ä¢ Mitarbeiter</button>
        <button id="logoutBtn" class="ghost hidden" title="Mitarbeiter abmelden">Abmelden</button>
      </div>
    </header>

    <section class="cards" id="cards">
      <div class="card"><h4 id="c1h">üöÄ Erste Schritte</h4><p id="c1p">Chromebook Basics & Shortcuts.</p><button data-intent="shortcuts" id="c1b">Tastenk√ºrzel</button></div>
      <div class="card"><h4 id="c2h">‚öôÔ∏è Leistung</h4><p id="c2p">Langsam? So wird‚Äôs flotter.</p><button data-intent="speed" id="c2b">Schneller machen</button></div>
      <div class="card"><h4 id="c3h">üêß Linux & Dev</h4><p id="c3p">Linux aktivieren & apt.</p><button data-intent="linux" id="c3b">Linux installieren</button></div>
      <div class="card"><h4 id="c4h">üõçÔ∏è Apps</h4><p id="c4p">Play-Store & PWAs.</p><button data-intent="apps" id="c4b">Apps & Spiele</button></div>
    </section>

    <section class="chatWrap">
      <div class="chatTabs">
        <button class="tab" id="tabBot">ü§ñ Bot</button>
        <button class="tab" id="tabStaff">üë®‚Äçüíª Mitarbeiter</button>
      </div>
      <section class="chat" id="chat" aria-live="polite" aria-label="Chatverlauf"></section>
      <form class="composer" id="composer" autocomplete="off">
        <input id="input" type="text" placeholder="Nachricht schreiben ‚Ä¶" />
        <button id="send" type="submit">Senden ‚ñ∂</button>
      </form>
    </section>
  </div>

  <div class="fab hidden" id="fab" title="Chat-Center (Mitarbeiter)">
    üí¨ <span class="badge hidden" id="badge">0</span>
  </div>

  <div class="modal-backdrop hidden" id="contactModal">
    <div class="modal">
      <h3 id="contactTitle">üëã Mitarbeiter kontaktieren</h3>
      <label for="contactMsg" id="contactLabel">Nachricht</label>
      <textarea id="contactMsg" rows="4" placeholder="Worum geht es?"></textarea>
      <div class="rowbtn">
        <button id="cancelContact" type="button">Abbrechen</button>
        <button id="sendContact" type="button">Absenden</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop hidden" id="ticketsModal">
    <div class="modal">
      <h3 id="ticketsTitle">üí¨ Chat-Center <span class="meta" id="openCount">(0 offen)</span></h3>
      <div id="ticketsList"></div>
      <div class="rowbtn"><button id="closeTickets" type="button">Schlie√üen</button></div>
    </div>
  </div>

  <div class="modal-backdrop hidden" id="replyModal">
    <div class="modal">
      <h3><span id="threadTitle">Thread</span> <span class="meta" id="replyTicketId"></span></h3>
      <div class="thread" id="thread"></div>
      <textarea id="replyText" rows="3" placeholder="Antwort schreiben ‚Ä¶"></textarea>
      <div class="rowbtn">
        <button id="replyBack" type="button">Zur√ºck</button>
        <button id="replyResolve" type="button">Als erledigt</button>
        <button id="sendReply" type="button">Antwort senden</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop hidden" id="loginModal">
    <div class="modal">
      <div id="step1">
        <h3 id="login1">üîí Geheim: Mitarbeiter-Login (1/3)</h3>
        <input id="code1" type="password" placeholder="Code 1" />
        <div class="rowbtn"><button id="cancelLogin" type="button">Abbrechen</button><button id="next1" type="button">Weiter</button></div>
      </div>
      <div id="step2" class="hidden">
        <h3 id="login2">üìß E-Mail (2/3)</h3>
        <input id="email" type="email" placeholder="komplette Mitarbeiter-E-Mail" />
        <p class="meta" id="emailHint">Hinweis: <strong>J1339K</strong> ‚Äì gib deine komplette E-Mail ein.</p>
        <div class="rowbtn"><button id="back1" type="button">Zur√ºck</button><button id="next2" type="button">Weiter</button></div>
      </div>
      <div id="step3" class="hidden">
        <h3 id="login3">üîë Zweiter Code (3/3)</h3>
        <input id="code2" type="password" placeholder="TT.MM.JJJJ" />
        <div class="rowbtn"><button id="back2" type="button">Zur√ºck</button><button id="finishLogin" type="button">Anmelden</button></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    const firebaseConfig = {apiKey:"AIzaSyDN1MZv_q38Zoymt92BHWTe9sUNwteT1KA",authDomain:"sample-firebase-ai-app-b02a4.firebaseapp.com",projectId:"sample-firebase-ai-app-b02a4",storageBucket:"sample-firebase-ai-app-b02a4.firebasestorage.app",messagingSenderId:"382050648468",appId:"1:382050648468:web:8c6f34051a7b2991ebcf81"};

    const I18N={de:{tabs:{bot:"ü§ñ Bot",staff:"üë®‚Äçüíª Mitarbeiter"},contactBtn:"Kontakt ‚Ä¢ Mitarbeiter",logout:"Abmelden",composerPH:"Nachricht schreiben ‚Ä¶",contact:{title:"üëã Mitarbeiter kontaktieren",label:"Nachricht",cancel:"Abbrechen",send:"Absenden",placeholder:"Worum geht es?"},tickets:{title:"üí¨ Chat-Center",none:"Keine Anfragen vorhanden.",open:"√ñffnen",resolve:"Als erledigt",del:"L√∂schen"},reply:{title:"Thread",back:"Zur√ºck",resolve:"Als erledigt",send:"Antwort senden",ph:"Antwort schreiben ‚Ä¶",whoStaff:"Mitarbeiter",whoUser:"Kunde"},staffHeader:"Chat mit Mitarbeiter ‚Ä¢ Ticket ##",staffNoActive:"Kein aktiver Mitarbeiter-Chat. Starte einen Kontakt oben √ºber ‚ÄûKontakt ‚Ä¢ Mitarbeiter‚Äú.",toast:{offline:"Live-Chat offline. Bitte Internet pr√ºfen.",created:"Ticket erstellt und Mitarbeiter-Chat ge√∂ffnet ‚úÖ",wrongCode:"Falscher Code.",wrongEmail:"E-Mail stimmt nicht.",wrongCode2:"Falscher zweiter Code.",loggedIn:"Mitarbeiter-Modus aktiviert üõ°Ô∏è",loggedOut:"Abgemeldet.",needMsg:"Bitte Nachricht eingeben.",needReply:"Bitte eine Antwort schreiben."},login:{s1:"üîí Geheim: Mitarbeiter-Login (1/3)",s2:"üìß E-Mail (2/3)",s3:"üîë Zweiter Code (3/3)",emailPH:"komplette Mitarbeiter-E-Mail",emailHint:"Hinweis: <strong>J1339K</strong> ‚Äì gib deine komplette E-Mail ein.",code2PH:"TT.MM.JJJJ",cancel:"Abbrechen",next:"Weiter",back:"Zur√ºck",finish:"Anmelden"},cards:{c1h:"üöÄ Erste Schritte",c1p:"Chromebook Basics & Shortcuts.",c1b:"Tastenk√ºrzel",c2h:"‚öôÔ∏è Leistung",c2p:"Langsam? So wird‚Äôs flotter.",c2b:"Schneller machen",c3h:"üêß Linux & Dev",c3p:"Linux aktivieren & apt.",c3b:"Linux installieren",c4h:"üõçÔ∏è Apps",c4p:"Play-Store & PWAs.",c4b:"Apps & Spiele"},firstRun:"Willkommen! ‚ú® Du kannst oben zwischen ü§ñ Bot und üë®‚Äçüíª Mitarbeiter umschalten. Wenn du ‚ÄûKontakt ‚Ä¢ Mitarbeiter‚Äú nutzt, √∂ffnet sich direkt der Live-Chat. ü§ù",meYou:{user:"Du",bot:"Helfer"},dateLocale:"de-DE",ticketsMetaFrom:"Von: ## ‚Ä¢ ",openCount:"(## offen)",fabTitle:"Chat-Center (Mitarbeiter)"},en:{tabs:{bot:"ü§ñ Bot",staff:"üë®‚Äçüíª Support"},contactBtn:"Contact ‚Ä¢ Support",logout:"Sign out",composerPH:"Type a message‚Ä¶",contact:{title:"üëã Contact support",label:"Message",cancel:"Cancel",send:"Send",placeholder:"What‚Äôs the issue?"},tickets:{title:"üí¨ Chat Center",none:"No requests yet.",open:"Open",resolve:"Mark as resolved",del:"Delete"},reply:{title:"Thread",back:"Back",resolve:"Mark as resolved",send:"Send reply",ph:"Write a reply‚Ä¶",whoStaff:"Support",whoUser:"Customer"},staffHeader:"Chat with Support ‚Ä¢ Ticket ##",staffNoActive:"No active support chat. Start one via ‚ÄúContact ‚Ä¢ Support‚Äù above.",toast:{offline:"Live chat offline. Please check your connection.",created:"Ticket created and live support chat opened ‚úÖ",wrongCode:"Wrong code.",wrongEmail:"Email doesn‚Äôt match.",wrongCode2:"Wrong second code.",loggedIn:"Staff mode enabled üõ°Ô∏è",loggedOut:"Signed out.",needMsg:"Please enter a message.",needReply:"Please write a reply."},login:{s1:"üîí Secret: Staff login (1/3)",s2:"üìß Email (2/3)",s3:"üîë Second code (3/3)",emailPH:"full staff email",emailHint:"Hint: <strong>J1339K</strong> ‚Äì please enter your full email.",code2PH:"DD.MM.YYYY",cancel:"Cancel",next:"Next",back:"Back",finish:"Sign in"},cards:{c1h:"üöÄ Getting started",c1p:"Chromebook basics & shortcuts.",c1b:"Shortcuts",c2h:"‚öôÔ∏è Performance",c2p:"Slow? Here‚Äôs how to speed it up.",c2b:"Speed up",c3h:"üêß Linux & Dev",c3p:"Enable Linux & apt.",c3b:"Install Linux",c4h:"üõçÔ∏è Apps",c4p:"Play Store & PWAs.",c4b:"Apps & games"},firstRun:"Welcome! ‚ú® You can switch between ü§ñ Bot and üë®‚Äçüíª Support above. If you use ‚ÄúContact ‚Ä¢ Support‚Äù, the live chat opens right away. ü§ù",meYou:{user:"You",bot:"Assistant"},dateLocale:"en-GB",ticketsMetaFrom:"From: ## ‚Ä¢ ",openCount:"(## open)",fabTitle:"Chat center (staff)"}};

    const $=(s,r=document)=>r.querySelector(s);const hide=e=>e.classList.add('hidden');const show=e=>e.classList.remove('hidden');
    const toast=(t,ms=2200)=>{const e=$('#toast');e.innerHTML=t;show(e);setTimeout(()=>hide(e),ms)};
    const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));const load=(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}};
    const uid=()=>Math.random().toString(36).slice(2,10);let lang=load('cbh_lang','de');document.documentElement.lang=lang;
    const deviceId=load('cbh_device')||(save('cbh_device','dev-'+uid()),load('cbh_device'));const fmt=t=>new Date(t).toLocaleString(I18N[lang].dateLocale,{year:'2-digit',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});

    const liveDot=$('#liveDot'),modeLabel=$('#modeLabel'),langBtn=$('#langBtn');let botChat=load('cbh_bot_chat',[]);let tickets=[];let staff=sessionStorage.getItem('cbh_staff')==='1';let activeTicketId=load('cbh_active_ticket',null);let mode=load('cbh_mode','bot');
    const chatEl=$('#chat'),input=$('#input');const contactBtn=$('#contactBtn'),badge=$('#badge');const fab=$('#fab');
    const contactModal=$('#contactModal'),contactMsg=$('#contactMsg');const ticketsModal=$('#ticketsModal'),ticketsList=$('#ticketsList'),openCount=$('#openCount');const closeTicketsBtn=$('#closeTickets');
    const replyModal=$('#replyModal'),thread=$('#thread'),replyText=$('#replyText'),replyTicketId=$('#replyTicketId');const sendReply=$('#sendReply'),replyBack=$('#replyBack'),replyResolve=$('#replyResolve');
    const loginModal=$('#loginModal'),code1=$('#code1'),email=$('#email'),code2=$('#code2');const next1=$('#next1'),next2=$('#next2'),finishLogin=$('#finishLogin'),cancelLogin=$('#cancelLogin'),back1=$('#back1'),back2=$('#back2');
    const logo=$('#logo'),logoutBtn=$('#logoutBtn');const tabBot=$('#tabBot'),tabStaff=$('#tabStaff');
    const contactTitle=$('#contactTitle'),contactLabel=$('#contactLabel'),cancelContact=$('#cancelContact'),sendContact=$('#sendContact');
    const ticketsTitle=$('#ticketsTitle'),closeTickets=$('#closeTickets');const replyTitle=$('#threadTitle'),replyBackBtn=$('#replyBack'),replyResolveBtn=$('#replyResolve'),sendReplyBtn=$('#sendReply');
    const login1=$('#login1'),login2=$('#login2'),login3=$('#login3'),emailHint=$('#emailHint');

    const FB={enabled:false,app:null,db:null,auth:null,unsub:null};
    try{FB.app=firebase.initializeApp(firebaseConfig);FB.auth=firebase.auth();FB.db=firebase.firestore();FB.auth.signInAnonymously().then(()=>{FB.enabled=true;liveDot.classList.add('live');modeLabel.textContent='Live';subscribeTickets()}).catch(e=>{console.error(e);modeLabel.textContent='Offline'})}catch(e){console.error('Firebase init failed',e);modeLabel.textContent='Offline'}

    function applyLang(){
      const T=I18N[lang];document.documentElement.lang=lang;
      tabBot.textContent=T.tabs.bot;tabStaff.textContent=T.tabs.staff;contactBtn.textContent=T.contactBtn;logoutBtn.textContent=T.logout;
      input.placeholder=T.composerPH;$('#contactMsg').placeholder=T.contact.placeholder;contactTitle.textContent=T.contact.title;contactLabel.textContent=T.contact.label;cancelContact.textContent=T.contact.cancel;sendContact.textContent=T.contact.send;
      $('#c1h').textContent=T.cards.c1h;$('#c1p').textContent=T.cards.c1p;$('#c1b').textContent=T.cards.c1b;$('#c2h').textContent=T.cards.c2h;$('#c2p').textContent=T.cards.c2p;$('#c2b').textContent=T.cards.c2b;$('#c3h').textContent=T.cards.c3h;$('#c3p').textContent=T.cards.c3p;$('#c3b').textContent=T.cards.c3b;$('#c4h').textContent=T.cards.c4h;$('#c4p').textContent=T.cards.c4p;$('#c4b').textContent=T.cards.c4b;
      ticketsTitle.childNodes[0].textContent=T.tickets.title+' ';replyTitle.textContent=T.reply.title;replyBackBtn.textContent=T.reply.back;replyResolveBtn.textContent=T.reply.resolve;sendReplyBtn.textContent=T.reply.send;replyText.placeholder=T.reply.ph;
      login1.textContent=T.login.s1;login2.textContent=T.login.s2;login3.textContent=T.login.s3;email.placeholder=T.login.emailPH;emailHint.innerHTML=T.login.emailHint;code2.placeholder=T.login.code2PH;cancelLogin.textContent=T.login.cancel;next1.textContent=T.login.next;next2.textContent=T.login.next;back1.textContent=T.login.back;back2.textContent=T.login.back;finishLogin.textContent=T.login.finish;
      $('#fab').title=T.fabTitle;updateBadge();renderChat();
    }

    const KB_DE=[{p:['hallo','hi','hey','moin','gr√º√ü'],r:'Hey! üëã Ich bin dein Chrombook-Helfer. Frag mich alles zu Chromebook, Linux, Apps & Leistung. ‚ú®'},{p:['tasten','shortcut','k√ºrzel','kombination'],r:'‚å®Ô∏è Shortcuts:\n‚Ä¢ Screenshot: Strg+‚ñ¢||\n‚Ä¢ Bereich: Strg+Umschalt+‚ñ¢||\n‚Ä¢ Tab neu/schlie√üen: Strg+T / Strg+W\n‚Ä¢ Task-Manager: Such + Esc üôÇ'},{p:['linux','crostini'],r:'üêß Linux: Einstellungen ‚Üí Entwickler ‚Üí Linux aktivieren. Dann: sudo apt update && sudo apt upgrade -y ‚Ä¢ sudo apt install git curl build-essential -y'},{p:['langsam','leistung','ruckelt','lag'],r:'‚ö° Schneller machen: Tabs/Erweiterungen pr√ºfen, Speicher aufr√§umen, Hardwarebeschleunigung aktivieren (Chrome ‚Üí System), Neustart/Powerwash als letzter Schritt.'},{p:['apps','play','android'],r:'üì± Apps: Einstellungen ‚Üí Apps ‚Üí Play-Store aktivieren ‚Üí im Store installieren. Viele Dienste auch als PWA verf√ºgbar. üõçÔ∏è'},{p:['druck','drucker','pdf'],r:'üñ®Ô∏è Drucken/PDF: Druck-Dialog ‚Üí ‚ÄûAls PDF speichern‚Äú oder Drucker unter Einstellungen ‚Üí ‚ÄûDrucker‚Äú hinzuf√ºgen. üìÑ'},{p:['hilfe','mitarbeiter','kontakt'],r:'ü§ù Wenn du pers√∂nliche Hilfe brauchst: Wechsel oben auf ‚Äûüë®‚Äçüíª Mitarbeiter‚Äú oder nutze ‚ÄûKontakt ‚Ä¢ Mitarbeiter‚Äú. Wir sind da!'}];
    const KB_EN=[{p:['hello','hi','hey','yo','greetings'],r:'Hey! üëã I‚Äôm your Chromebook helper. Ask me anything about ChromeOS, Linux, apps and performance. ‚ú®'},{p:['keys','shortcut','shortcuts','hotkey','hotkeys'],r:'‚å®Ô∏è Shortcuts:\n‚Ä¢ Screenshot: Ctrl+Show windows (‚ñ¢||)\n‚Ä¢ Area screenshot: Ctrl+Shift+Show windows (‚ñ¢||)\n‚Ä¢ New/close tab: Ctrl+T / Ctrl+W\n‚Ä¢ Task manager: Search (üîç) + Esc üôÇ'},{p:['linux','crostini'],r:'üêß Linux: Settings ‚Üí Developers ‚Üí Linux development environment. Then: sudo apt update && sudo apt upgrade -y ‚Ä¢ sudo apt install git curl build-essential -y'},{p:['slow','lag','performance','stutter'],r:'‚ö° Speed up: review tabs/extensions, free storage, enable hardware acceleration (Chrome ‚Üí System), restart / Powerwash as a last resort.'},{p:['apps','play','android','pwa'],r:'üì± Apps: enable the Play Store in Settings ‚Üí Apps ‚Üí Google Play Store, or install PWAs from the web. üõçÔ∏è'},{p:['print','printer','pdf'],r:'üñ®Ô∏è Printing/PDF: use ‚ÄúSave as PDF‚Äù in the print dialog, or add printers under Settings ‚Üí Printing.'},{p:['help','human','support','contact'],r:'ü§ù Need personal help? Switch to ‚Äúüë®‚Äçüíª Support‚Äù above or use ‚ÄúContact ‚Ä¢ Support‚Äù. We‚Äôve got you!'}];
    function botAnswer(q){const KB=lang==='de'?KB_DE:KB_EN;const s=(q||'').toLowerCase();for(const e of KB){if(e.p.some(x=>s.includes(x)))return e.r+' ‚ú®'}return lang==='de'?'Ich bin mir nicht sicher. ü§î‚û°Ô∏è Ich verweise dich an einen Mitarbeiter. Wechsle auf ‚Äûüë®‚Äçüíª Mitarbeiter‚Äú. üôå':'I‚Äôm not sure. ü§î‚û°Ô∏è I‚Äôll refer you to a human. Switch to ‚Äúüë®‚Äçüíª Support‚Äù. üôå'}

    function normalizeDoc(id,d){const messages=Array.isArray(d.messages)?d.messages.slice():[];if(messages.length===0){if(d.message)messages.push({by:'user',text:d.message,time:d.time||Date.now()});if(Array.isArray(d.replies)){for(const r of d.replies){messages.push({by:'staff',text:r.text,time:r.time||Date.now()})}}}return{id,from:d.from,time:d.time||0,status:d.status||'offen',message:d.message||(messages[0]?.text||''),messages}}
    async function createTicket(message){const ref=await FB.db.collection('cbh_tickets').add({from:deviceId,message,time:Date.now(),status:'offen',messages:[{by:'user',text:message,time:Date.now()}]});activeTicketId=ref.id;save('cbh_active_ticket',activeTicketId);mode='staff';renderChat();toast(I18N[lang].toast.created)}
    async function sendToStaff(text){if(!activeTicketId){await createTicket(text);return}await FB.db.collection('cbh_tickets').doc(activeTicketId).update({messages:firebase.firestore.FieldValue.arrayUnion({by:'user',text, time:Date.now()})})}

    function renderBotChat(){const MY=I18N[lang].meYou;chatEl.innerHTML='';for(const m of botChat){const w=document.createElement('div');w.className='msg '+(m.role==='user'?'user':'bot');const a=document.createElement('div');a.className='avatar';a.textContent=m.role==='user'?'üë§':'ü§ñ';const b=document.createElement('div');b.className='bubble';b.textContent=m.text;const me=document.createElement('div');me.className='meta';me.textContent=(m.role==='user'?MY.user:MY.bot)+' ‚Ä¢ '+fmt(m.time);const col=document.createElement('div');col.appendChild(b);col.appendChild(me);w.appendChild(a);w.appendChild(col);chatEl.appendChild(w)}chatEl.scrollTop=chatEl.scrollHeight;save('cbh_bot_chat',botChat)}
    function renderStaffChat(){const T=I18N[lang];chatEl.innerHTML='';let t=tickets.find(x=>x.id===activeTicketId);if(!t){const my=tickets.filter(x=>x.from===deviceId).sort((a,b)=>(b.time||0)-(a.time||0));if(my[0]){activeTicketId=my[0].id;save('cbh_active_ticket',activeTicketId);t=my[0]}}if(!t){chatEl.innerHTML='<div class="meta">'+T.staffNoActive+'</div>';return}const hdr=document.createElement('div');hdr.className='meta';hdr.textContent=T.staffHeader.replace('##',t.id)+(t.status==='erledigt'?(lang==='de'?' (erledigt)':' (resolved)'):'');chatEl.appendChild(hdr);const msgs=Array.isArray(t.messages)?t.messages:[];for(const m of msgs){const w=document.createElement('div');w.className='msg '+(m.by==='user'?'user':'bot');const a=document.createElement('div');a.className='avatar';a.textContent=m.by==='user'?'üë§':'üë®‚Äçüíª';const b=document.createElement('div');b.className='bubble';b.textContent=m.text;const who=m.by==='user'?(lang==='de'?'Du':'You'):(lang==='de'?'Mitarbeiter':'Support');const me=document.createElement('div');me.className='meta';me.textContent=who+' ‚Ä¢ '+fmt(m.time);const col=document.createElement('div');col.appendChild(b);col.appendChild(me);w.appendChild(a);w.appendChild(col);chatEl.appendChild(w)}chatEl.scrollTop=chatEl.scrollHeight}
    function renderChat(){tabBot.classList.toggle('active',mode==='bot');tabStaff.classList.toggle('active',mode==='staff');if(mode==='bot')renderBotChat();else renderStaffChat();save('cbh_mode',mode)}

    document.querySelector('#composer').addEventListener('submit',async ev=>{ev.preventDefault();const val=(input.value||'').trim();if(!val)return;if(val==='/login'){openLogin();input.value='';return}if(val==='/en'){lang='en';save('cbh_lang',lang);applyLang();input.value='';return}if(val==='/de'){lang='de';save('cbh_lang',lang);applyLang();input.value='';return}if(mode==='bot'){botChat.push({role:'user',text:val,time:Date.now()});renderBotChat();setTimeout(()=>{botChat.push({role:'bot',text:botAnswer(val),time:Date.now()});renderBotChat()},150)}else{if(!FB.enabled){toast(I18N[lang].toast.offline);input.value='';return}await sendToStaff(val)}input.value=''});
    tabBot.addEventListener('click',()=>{mode='bot';renderChat()});tabStaff.addEventListener('click',()=>{mode='staff';renderChat()});

    const BOT_PROMPTS={de:{shortcuts:'Welche Tastenk√ºrzel gibt es?',speed:'Mein Chromebook ist langsam. Was tun?',linux:'Wie installiere ich Linux (Crostini)?',apps:'Wie installiere ich Apps?'},en:{shortcuts:'What are the most useful shortcuts?',speed:'My Chromebook is slow. What can I do?',linux:'How do I install Linux (Crostini)?',apps:'How do I install apps?'}};
    document.querySelector('#cards').addEventListener('click',e=>{const b=e.target.closest('button[data-intent]');if(!b)return;const m=BOT_PROMPTS[lang][b.dataset.intent];if(m){botChat.push({role:'user',text:m,time:Date.now()});setTimeout(()=>{botChat.push({role:'bot',text:botAnswer(m),time:Date.now()});renderBotChat()},150);renderBotChat()}});

    function openContact(){show(contactModal);$('#contactMsg').focus()}function closeContact(){hide(contactModal)}
    contactBtn.addEventListener('click',()=>{if(staff)openTickets();else openContact()});$('#cancelContact').addEventListener('click',closeContact);
    $('#sendContact').addEventListener('click',async ()=>{const msg=(contactMsg.value||'').trim();if(!msg){toast(I18N[lang].toast.needMsg);return}if(!FB.enabled){toast(I18N[lang].toast.offline);return}await createTicket(msg);contactMsg.value='';closeContact();mode='staff';renderChat()});

    function openTickets(){renderTickets();show(ticketsModal)}function closeTicketsModal(){hide(ticketsModal)}$('#closeTickets').addEventListener('click',closeTicketsModal);
    $('#ticketsList').addEventListener('click',async e=>{const btn=e.target.closest('button[data-act]');if(!btn)return;const id=btn.dataset.id;const act=btn.dataset.act;if(act==='resolve'){await FB.db.collection('cbh_tickets').doc(id).update({status:'erledigt'})}if(act==='delete'){await FB.db.collection('cbh_tickets').doc(id).delete()}if(act==='reply'){activeTicketId=id;save('cbh_active_ticket',id);openReply(id)}});
    function renderTickets(){const T=I18N[lang];ticketsList.innerHTML='';if(tickets.length===0){ticketsList.innerHTML='<p class="meta">'+T.tickets.none+'</p>';return}for(const t of tickets){const last=t.messages&&t.messages.length?t.messages[t.messages.length-1]:null;const preview=last?(last.by==='staff'?'üë®‚Äçüíª ':'üë§ ')+escapeHTML(last.text).slice(0,80):escapeHTML(t.message).slice(0,80);const el=document.createElement('div');el.className='ticket';el.innerHTML=`<div><strong>Ticket:</strong> ${t.id} ‚Ä¢ <span class="tag">${t.status}</span></div><div class="meta">${(lang==='de'?'Von: ':'From: ')+t.from} ‚Ä¢ ${fmt(t.time)}</div><div style="margin:6px 0 8px;white-space:pre-wrap;">${preview}</div><div class="rowbtn"><button data-act="reply" data-id="${t.id}">${T.tickets.open}</button><button data-act="resolve" data-id="${t.id}">${T.tickets.resolve}</button><button data-act="delete" data-id="${t.id}">${T.tickets.del}</button></div>`;ticketsList.appendChild(el)}const open=tickets.filter(t=>t.status==='offen').length;openCount.textContent=' '+(lang==='de'?`(${open} offen)`: `(${open} open)`)}
    function escapeHTML(s){return (s||'').replace(/[&<>]/g,t=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[t]))}

    function openReply(id){const T=I18N[lang];const t=tickets.find(x=>x.id===id);if(!t)return;replyTicketId.textContent='#'+t.id;renderThread(t);replyText.placeholder=T.reply.ph;show(replyModal)}
    function closeReply(){hide(replyModal)}replyBack.addEventListener('click',()=>{closeReply();openTickets()});
    replyResolve.addEventListener('click',async ()=>{const id=activeTicketId;if(!id)return;await FB.db.collection('cbh_tickets').doc(id).update({status:'erledigt'});toast(lang==='de'?'Ticket erledigt ‚úÖ':'Ticket resolved ‚úÖ');renderTickets();closeReply()});
    sendReply.addEventListener('click',async ()=>{const txt=(replyText.value||'').trim();if(!txt){toast(I18N[lang].toast.needReply);return}await FB.db.collection('cbh_tickets').doc(activeTicketId).update({messages:firebase.firestore.FieldValue.arrayUnion({by:'staff',text:txt,time:Date.now()})});replyText.value=''});
    function renderThread(t){const T=I18N[lang];thread.innerHTML='';const msgs=Array.isArray(t.messages)?t.messages:[];for(const m of msgs){const d=document.createElement('div');d.className='tmsg '+(m.by==='staff'?'right':'');d.innerHTML=`<div class="who">${m.by==='staff'?T.reply.whoStaff:T.reply.whoUser}</div><div class="txt">${escapeHTML(m.text)}<div class="meta">${fmt(m.time)}</div></div>`;thread.appendChild(d)}thread.scrollTop=thread.scrollHeight}

    function subscribeTickets(){if(FB.unsub){try{FB.unsub()}catch{}FB.unsub=null}let q;if(staff){q=FB.db.collection('cbh_tickets').orderBy('time','desc').limit(200)}else{q=FB.db.collection('cbh_tickets').where('from','==',deviceId)}FB.unsub=q.onSnapshot(async snap=>{const arr=[];const mig=[];snap.forEach(doc=>{const d=doc.data()||{};const n=normalizeDoc(doc.id,d);arr.push(n);if(!Array.isArray(d.messages))mig.push({id:doc.id,n})});tickets=arr;for(const m of mig){try{await FB.db.collection('cbh_tickets').doc(m.id).update({messages:m.n.messages})}catch{}}if(mode==='staff')renderStaffChat();if(staff)renderTickets()},err=>{console.error('snapshot error',err);modeLabel.textContent='Error';liveDot.classList.remove('live')})}

    function openLogin(){show(loginModal);hide($('#step2'));hide($('#step3'));show($('#step1'));setTimeout(()=>code1.focus(),50)}function closeLogin(){hide(loginModal)}
    let logoClicks=0,logoTimer=null;logo.addEventListener('click',()=>{logoClicks++;if(logoTimer)clearTimeout(logoTimer);logoTimer=setTimeout(()=>{logoClicks=0},500);if(logoClicks>=3){openLogin();logoClicks=0}});
    window.addEventListener('keydown',e=>{const isHash=e.key==='#'||e.code==='Backslash'||(e.code==='Digit3'&&(e.altKey||e.ctrlKey));if(e.ctrlKey&&e.altKey&&isHash){e.preventDefault();openLogin()}if(e.key==='Escape'){hide(contactModal);hide(loginModal);hide(ticketsModal);hide(replyModal)}});
    cancelLogin.addEventListener('click',closeLogin);
    next1.addEventListener('click',()=>{if(code1.value.trim()==='140318'){hide($('#step1'));show($('#step2'));email.focus()}else toast(I18N[lang].toast.wrongCode)});
    next2.addEventListener('click',()=>{if((email.value||'').trim().toLowerCase()==='julian1339klausch@gmx.de'){hide($('#step2'));show($('#step3'));code2.focus()}else toast(I18N[lang].toast.wrongEmail)});
    back1.addEventListener('click',()=>{hide($('#step2'));show($('#step1'))});back2.addEventListener('click',()=>{hide($('#step3'));show($('#step2'))});
    finishLogin.addEventListener('click',()=>{if(code2.value.trim()==='11.09.2000'){sessionStorage.setItem('cbh_staff','1');staff=true;applyStaffUI();toast(I18N[lang].toast.loggedIn);closeLogin();subscribeTickets()}else toast(I18N[lang].toast.wrongCode2)});

    function applyStaffUI(){const T=I18N[lang];if(staff){contactBtn.textContent=(lang==='de'?'Chat-Center':'Chat center');contactBtn.title=(lang==='de'?'Chat-Center √∂ffnen':'Open chat center');show(logoutBtn);show(fab)}else{contactBtn.textContent=T.contactBtn;contactBtn.title=(lang==='de'?'Mitarbeiter kontaktieren':'Contact support');hide(logoutBtn);hide(fab)}updateBadge()}
    logoutBtn.addEventListener('click',()=>{staff=false;sessionStorage.removeItem('cbh_staff');applyStaffUI();toast(I18N[lang].toast.loggedOut);subscribeTickets()});
    fab.addEventListener('click',()=>{if(staff)openTickets()});

    function updateBadge(){const openLocal=tickets.filter(t=>t.status==='offen').length;openCount.textContent=' '+(lang==='de'?`(${openLocal} offen)`:`(${openLocal} open)`);if(staff){if(openLocal>0){badge.textContent=String(openLocal);show(badge)}else hide(badge)}}
    langBtn.addEventListener('click',()=>{lang=(lang==='de'?'en':'de');save('cbh_lang',lang);applyLang()});

    if(!load('cbh_seen_v8',false)){const greet=I18N[lang].firstRun;botChat.push({role:'bot',text:greet,time:Date.now()});save('cbh_seen_v8',true)}
    applyLang();renderChat();applyStaffUI();
  });
  </script>
</body>
</html>
