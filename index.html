<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Chrombook Helfer Bot ‚Äì v12p (Always‚ÄëAI + Proxy URL File)</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <!-- Load proxy URL (edit this file only) -->
  <script src="cbh-proxy-url.js"></script>
  <style>
    :root{ --bg:#0b0f19; --panel:#121a2a; --panel2:#0f1726; --border:#20304e; --text:#e9eef7; --muted:#a3b0c7; --danger:#ff6b6b; --success:#3ddc97; }
    *{ box-sizing:border-box; } html,body{ height:100%; margin:0; overflow-x:hidden; background: radial-gradient(1200px 800px at 10% -10%, #1b2440 0%, transparent 60%), var(--bg); color:var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,sans-serif; }
    .app{ max-width:980px; margin-inline:auto; display:flex; flex-direction:column; min-height:100dvh; padding:12px; }
    header{ position:sticky; top:0; z-index:5; background: linear-gradient(135deg, rgba(109,124,255,.25), rgba(0,212,255,.12)), var(--panel); border:1px solid var(--border); border-radius:14px; padding:8px 10px; }
    .row{ display:flex; align-items:center; gap:8px; flex-wrap:nowrap; } .sp{ flex:1; }
    .logo{ display:flex; align-items:center; gap:8px; text-decoration:none; color:inherit; user-select:none; min-width:0; }
    .logo svg{ width:28px; height:28px; border-radius:8px; flex:0 0 auto; } .title{ font-weight:700; font-size: clamp(14px, 2.4vw, 17px); line-height:1.1; white-space:nowrap; } .brandSub{ font-size:11px; color:#8ea2ff; white-space:nowrap; }
    button{ font:inherit; color:var(--text); background: linear-gradient(180deg,#1b2440,#121a2a); border:1px solid var(--border); padding:8px 10px; border-radius:10px; cursor:pointer; white-space:nowrap; }
    button:hover{ filter:brightness(1.06); } .ghost{ background:transparent; border-color:var(--border); } .pill{ padding:5px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; display:inline-flex; align-items:center; gap:6px; }
    .cards{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:10px; } @media (min-width:680px){ .cards{ grid-template-columns:repeat(4,1fr); } }
    .card{ border:1px solid var(--border); background: linear-gradient(180deg,var(--panel),var(--panel2)); border-radius:16px; padding:12px; } .card h4{ margin:0 0 6px; font-size:14px; color:#c9d7ff; } .card p{ margin:0 0 8px; font-size:13px; color:var(--muted); }
    .chatWrap{ margin-top:10px; border:1px solid var(--border); border-radius:16px; background: linear-gradient(180deg,#0e152b,#0b1120); }
    .chatTabs{ display:flex; gap:8px; padding:8px; border-bottom:1px solid var(--border); align-items:center; } .tab{ padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:linear-gradient(180deg,#121a2a,#0f1726); cursor:pointer; font-size:14px; }
    .tab.active{ outline:2px solid rgba(109,124,255,.5); } .tab.slim{ padding:6px 8px; font-size:12px; margin-left:auto; }
    .chat{ padding:12px; display:flex; flex-direction:column; gap:10px; min-height:44dvh; } .msg{ display:flex; gap:8px; align-items:flex-start; }
    .msg .bubble{ background: linear-gradient(180deg,#121a2a,#0f1726); border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:14px; line-height:1.4; white-space:pre-wrap; }
    .msg.user .bubble{ background: linear-gradient(180deg,#0f1524,#0a0f19); } .avatar{ width:28px; height:28px; border-radius:50%; display:grid; place-items:center; background: radial-gradient(circle at 35% 35%, #9bb3ff, #6d7cff 40%, #0b0f19 70%); border:1px solid rgba(255,255,255,.12); flex:0 0 auto; }
    .composer{ position:sticky; bottom:0; display:flex; gap:8px; border-top:1px solid var(--border); padding:8px; background: linear-gradient(180deg,#0b1120,#0b1120); border-radius:0 0 16px 16px; } .composer input{ flex:1; border:1px solid var(--border); border-radius:10px; padding:12px 12px; background:#0b1120; color:#e9eef7; }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:14px; background: rgba(0,0,0,.6); border:1px solid var(--border); padding:10px 12px; border-radius:12px; z-index:40; }
    .fab{ position:fixed; right:16px; bottom:84px; width:56px; height:56px; border-radius:50%; display:grid; place-items:center; background: linear-gradient(135deg, rgba(109,124,255,.85), rgba(0,212,255,.65)); border:1px solid rgba(255,255,255,.18); z-index:15; }
    .badge{ position:absolute; top:-6px; right:-6px; min-width:18px; height:18px; padding:0 5px; display:grid; place-items:center; background: var(--danger); color:white; border-radius:999px; font-size:11px; font-weight:700; border:1px solid rgba(255,255,255,.35); }
    .modal-backdrop{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; padding:16px; background: rgba(0,0,0,.55); z-index:20; }
    .modal{ width:min(780px,96vw); background: linear-gradient(180deg,var(--panel),var(--panel2)); border:1px solid var(--border); border-radius:16px; padding:14px; }
    .modal input, .modal textarea{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0b1120; color:#e9eef7; }
    .rowbtn{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; } .hidden{ display:none !important; } .meta{ font-size:12px; color:var(--muted); }
    .ticket{ border:1px solid var(--border); border-radius:12px; padding:10px; background: linear-gradient(180deg,#0f1526,#0c1222); margin-top:8px; } .tag{ display:inline-block; border:1px solid var(--border); border-radius:999px; padding:2px 8px; font-size:11px; color:#c9d7ff; }
    .thread{ max-height:38vh; overflow:auto; border:1px solid var(--border); border-radius:12px; padding:10px; background: linear-gradient(180deg,#0f1526,#0c1222); }
    .tmsg{ display:flex; gap:8px; margin-bottom:8px; } .tmsg .who{ font-weight:700; font-size:12px; color:#c9d7ff; min-width:100px; } .tmsg .txt{ white-space:pre-wrap; } .right{ justify-content:flex-end; }
    @media (max-width: 480px){ header{ padding:6px 8px; } .row{ gap:6px; } .logo svg{ width:24px; height:24px; } .title{ font-size:14px; } .brandSub{ display:none; } button{ padding:6px 8px; font-size:12px; } .pill{ display:none; } }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="row">
        <a href="#" class="logo" id="logo" title="Chrombook Helfer">
          <svg viewBox="0 0 64 64" aria-hidden="true">
            <defs><radialGradient id="lg" cx="50%" cy="50%" r="70%"><stop offset="0%" stop-color="#cfe3ff"/><stop offset="40%" stop-color="#7ea3ff"/><stop offset="100%" stop-color="#0a0f1d"/></radialGradient></defs>
            <rect width="64" height="64" rx="12" fill="url(#lg)"/>
            <g opacity="0.9"><circle cx="16" cy="18" r="2" fill="white"/><circle cx="46" cy="14" r="1.2" fill="white"/><circle cx="40" cy="34" r="1.1" fill="white"/><circle cx="24" cy="48" r="1.2" fill="white"/></g>
            <path d="M10 50 Q32 30 54 50" stroke="#7ef3ff" stroke-width="2" fill="none" opacity="0.8"/>
          </svg>
          <div><div class="title">Chrombook&nbsp;Helfer</div><div class="brandSub">Galaxy ‚Ä¢ Dark</div></div>
        </a>
        <div class="sp"></div>
        <span id="livePill" class="pill"><span class="dot" id="liveDot" style="width:8px;height:8px;border-radius:50%;background:#666;display:inline-block"></span><span id="modeLabel">Offline</span></span>
        <button id="langBtn" class="ghost" title="Sprache / Language">DE ‚Ä¢ EN</button>
        <button id="contactBtn" title="Support">Kontakt</button>
        <button id="logoutBtn" class="ghost hidden" title="Mitarbeiter abmelden">Abmelden</button>
      </div>
    </header>

    <section class="cards" id="cards">
      <div class="card"><h4 id="c1h">üöÄ Erste Schritte</h4><p id="c1p">Chromebook Basics & Shortcuts.</p><button data-intent="shortcuts" id="c1b">Tastenk√ºrzel</button></div>
      <div class="card"><h4 id="c2h">‚öôÔ∏è Leistung</h4><p id="c2p">Langsam? So wird‚Äôs flotter.</p><button data-intent="speed" id="c2b">Schneller machen</button></div>
      <div class="card"><h4 id="c3h">üêß Linux & Dev</h4><p id="c3p">Linux aktivieren & apt.</p><button data-intent="linux" id="c3b">Linux installieren</button></div>
      <div class="card"><h4 id="c4h">üõçÔ∏è Apps</h4><p id="c4p">Play-Store & PWAs.</p><button data-intent="apps" id="c4b">Apps & Spiele</button></div>
    </section>

    <section class="chatWrap">
      <div class="chatTabs">
        <button class="tab" id="tabBot">ü§ñ Bot</button>
        <button class="tab" id="tabStaff">üë®‚Äçüíª Mitarbeiter</button>
        <button class="tab slim" id="clearBotBtn" title="Bot-Chat l√∂schen">üóëÔ∏è</button>
      </div>
      <section class="chat" id="chat" aria-live="polite" aria-label="Chatverlauf"></section>
      <form class="composer" id="composer" autocomplete="off">
        <input id="input" type="text" placeholder="Nachricht schreiben ‚Ä¶" />
        <button id="send" type="submit">Senden ‚ñ∂</button>
      </form>
    </section>
  </div>

  <div class="fab hidden" id="fab" title="Chat-Center (Mitarbeiter)">
    üí¨ <span class="badge hidden" id="badge">0</span>
  </div>

  <!-- Kontakt Modal -->
  <div class="modal-backdrop hidden" id="contactModal">
    <div class="modal">
      <h3 id="contactTitle">üëã Mitarbeiter kontaktieren</h3>
      <label for="contactMsg" id="contactLabel">Nachricht</label>
      <textarea id="contactMsg" rows="4" placeholder="Worum geht es?"></textarea>
      <div class="rowbtn">
        <button id="cancelContact" type="button">Abbrechen</button>
        <button id="sendContact" type="button">Absenden</button>
      </div>
    </div>
  </div>

  <!-- Tickets (Staff) -->
  <div class="modal-backdrop hidden" id="ticketsModal">
    <div class="modal">
      <h3 id="ticketsTitle">üí¨ Chat-Center <span class="meta" id="openCount">(0 offen)</span></h3>
      <div id="ticketsList"></div>
      <div class="rowbtn"><button id="closeTickets" type="button">Schlie√üen</button></div>
    </div>
  </div>

  <!-- Reply (Staff) -->
  <div class="modal-backdrop hidden" id="replyModal">
    <div class="modal">
      <h3><span id="threadTitle">Thread</span> <span class="meta" id="replyTicketId"></span></h3>
      <div class="thread" id="thread"></div>
      <textarea id="replyText" rows="3" placeholder="Antwort schreiben ‚Ä¶"></textarea>
      <div class="rowbtn">
        <button id="replyBack" type="button">Zur√ºck</button>
        <button id="replyResolve" type="button">Als erledigt</button>
        <button id="sendReply" type="button">Antwort senden</button>
      </div>
    </div>
  </div>

  <!-- Login -->
  <div class="modal-backdrop hidden" id="loginModal">
    <div class="modal">
      <div id="step1">
        <h3 id="login1">üîí Geheim: Mitarbeiter-Login (1/3)</h3>
        <input id="code1" type="password" placeholder="Code 1" />
        <div class="rowbtn"><button id="cancelLogin" type="button">Abbrechen</button><button id="next1" type="button">Weiter</button></div>
      </div>
      <div id="step2" class="hidden">
        <h3 id="login2">üìß E-Mail (2/3)</h3>
        <input id="email" type="email" placeholder="komplette Mitarbeiter-E-Mail" />
        <p class="meta" id="emailHint">Hinweis: <strong>J1339K</strong> ‚Äì gib deine komplette E-Mail ein.</p>
        <div class="rowbtn"><button id="back1" type="button">Zur√ºck</button><button id="next2" type="button">Weiter</button></div>
      </div>
      <div id="step3" class="hidden">
        <h3 id="login3">üîë Zweiter Code (3/3)</h3>
        <input id="code2" type="password" placeholder="TT.MM.JJJJ" />
        <div class="rowbtn"><button id="back2" type="button">Zur√ºck</button><button id="finishLogin" type="button">Anmelden</button></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

  <script>
  document.addEventListener('DOMContentLoaded', function(){
    // ===== Read proxy URL from external file or querystring =====
    let PROXY_URL = (typeof window.CBH_PROXY_URL === 'string' && window.CBH_PROXY_URL.trim()) ? window.CBH_PROXY_URL.trim() : "";
    const urlParams = new URLSearchParams(location.search);
    if(urlParams.get('proxy')) PROXY_URL = urlParams.get('proxy');

    // ===== Firebase (live sync) =====
    const firebaseConfig = {apiKey:"AIzaSyDN1MZv_q38Zoymt92BHWTe9sUNwteT1KA",authDomain:"sample-firebase-ai-app-b02a4.firebaseapp.com",projectId:"sample-firebase-ai-app-b02a4",storageBucket:"sample-firebase-ai-app-b02a4.firebasestorage.app",messagingSenderId:"382050648468",appId:"1:382050648468:web:8c6f34051a7b2991ebcf81"};

    // ===== I18N =====
    const I18N={
      de:{tabs:{bot:"ü§ñ Bot",staff:"üë®‚Äçüíª Mitarbeiter"},contactBtn:"Kontakt",logout:"Abmelden",composerPH:"Nachricht schreiben ‚Ä¶",clearBot:"üóëÔ∏è Bot-Chat l√∂schen",confirmClear:"M√∂chtest du den Bot-Chat wirklich l√∂schen? Das kann nicht r√ºckg√§ngig gemacht werden.",contact:{title:"üëã Mitarbeiter kontaktieren",label:"Nachricht",cancel:"Abbrechen",send:"Absenden",placeholder:"Worum geht es?"},tickets:{title:"üí¨ Chat-Center",none:"Keine Anfragen vorhanden.",open:"√ñffnen",resolve:"Als erledigt",del:"L√∂schen"},reply:{title:"Thread",back:"Zur√ºck",resolve:"Als erledigt",send:"Antwort senden",ph:"Antwort schreiben ‚Ä¶",whoStaff:"Mitarbeiter",whoUser:"Kunde"},staffHeader:"Chat mit Mitarbeiter ‚Ä¢ Ticket ##",staffNoActive:"Kein aktiver Mitarbeiter-Chat. Starte einen Kontakt oben √ºber ‚ÄûKontakt‚Äú. ",toast:{offline:"Live-Chat offline. Bitte Internet pr√ºfen.",created:"Ticket erstellt und Mitarbeiter-Chat ge√∂ffnet ‚úÖ",wrongCode:"Falscher Code.",wrongEmail:"E-Mail stimmt nicht.",wrongCode2:"Falscher zweiter Code.",loggedIn:"Mitarbeiter-Modus aktiviert üõ°Ô∏è",loggedOut:"Abgemeldet.",needMsg:"Bitte Nachricht eingeben.",needReply:"Bitte eine Antwort schreiben.", aiFail:"KI nicht erreichbar ‚Äì ich nutze meine Standard-Antworten. ü§ù"},cards:{c1h:"üöÄ Erste Schritte",c1p:"Chromebook Basics & Shortcuts.",c1b:"Tastenk√ºrzel",c2h:"‚öôÔ∏è Leistung",c2p:"Langsam? So wird‚Äôs flotter.",c2b:"Schneller machen",c3h:"üêß Linux & Dev",c3p:"Linux aktivieren & apt.",c3b:"Linux installieren",c4h:"üõçÔ∏è Apps",c4p:"Play-Store & PWAs.",c4b:"Apps & Spiele"},firstRun:"Willkommen! ‚ú® Du kannst oben zwischen ü§ñ Bot und üë®‚Äçüíª Mitarbeiter umschalten. Wenn du ‚ÄûKontakt‚Äú nutzt, √∂ffnet sich direkt der Live-Chat. ü§ù",meYou:{user:"Du",bot:"Helfer"},dateLocale:"de-DE",fabTitle:"Chat-Center (Mitarbeiter)"},
      en:{tabs:{bot:"ü§ñ Bot",staff:"üë®‚Äçüíª Support"},contactBtn:"Support",logout:"Sign out",composerPH:"Type a message‚Ä¶",clearBot:"üóëÔ∏è Clear bot chat",confirmClear:"Do you really want to clear the bot chat? This cannot be undone.",contact:{title:"üëã Contact support",label:"Message",cancel:"Cancel",send:"Send",placeholder:"What‚Äôs the issue?"},tickets:{title:"üí¨ Chat Center",none:"No requests yet.",open:"Open",resolve:"Mark as resolved",del:"Delete"},reply:{title:"Thread",back:"Back",resolve:"Mark as resolved",send:"Send reply",ph:"Write a reply‚Ä¶",whoStaff:"Support",whoUser:"Customer"},staffHeader:"Chat with Support ‚Ä¢ Ticket ##",staffNoActive:"No active support chat. Start one via ‚ÄúSupport‚Äù above.",toast:{offline:"Live chat offline. Please check your connection.",created:"Ticket created and live support chat opened ‚úÖ",wrongCode:"Wrong code.",wrongEmail:"Email doesn‚Äôt match.",wrongCode2:"Wrong second code.",loggedIn:"Staff mode enabled üõ°Ô∏è",loggedOut:"Signed out.",needMsg:"Please enter a message.",needReply:"Please write a reply.", aiFail:"AI not reachable ‚Äî I‚Äôll use my standard answers. ü§ù"},cards:{c1h:"üöÄ Getting started",c1p:"Chromebook basics & shortcuts.",c1b:"Shortcuts",c2h:"‚öôÔ∏è Performance",c2p:"Slow? Here‚Äôs how to speed it up.",c2b:"Speed up",c3h:"üêß Linux & Dev",c3p:"Enable Linux & apt.",c3b:"Install Linux",c4h:"üõçÔ∏è Apps",c4p:"Play Store & PWAs.",c4b:"Apps & games"},firstRun:"Welcome! ‚ú® You can switch between ü§ñ Bot and üë®‚Äçüíª Support above. If you use ‚ÄúSupport‚Äù, the live chat opens right away. ü§ù",meYou:{user:"You",bot:"Assistant"},dateLocale:"en-GB",fabTitle:"Chat center (staff)"}
    };

    const $=(s,r=document)=>r.querySelector(s), hide=e=>e.classList.add('hidden'), show=e=>e.classList.remove('hidden');
    const toast=(t,ms=2200)=>{const e=$('#toast');e.innerHTML=t;show(e);setTimeout(()=>hide(e),ms)};
    const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v)), load=(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}};
    const uid=()=>Math.random().toString(36).slice(2,10);
    let lang=load('cbh_lang','de'); document.documentElement.lang=lang;
    const deviceId=load('cbh_device')||(save('cbh_device','dev-'+uid()),load('cbh_device'));
    const fmt=t=> new Date(t).toLocaleString(I18N[lang].dateLocale,{year:'2-digit',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});

    const liveDot=$('#liveDot'), modeLabel=$('#modeLabel'), langBtn=$('#langBtn');
    let botChat=load('cbh_bot_chat',[]);
    let tickets=[]; let staff=sessionStorage.getItem('cbh_staff')==='1';
    let activeTicketId=load('cbh_active_ticket',null);
    let mode=load('cbh_mode','bot');

    const chatEl=$('#chat'), input=$('#input'); const contactBtn=$('#contactBtn');
    const contactModal=$('#contactModal'), contactMsg=$('#contactMsg');
    const ticketsModal=$('#ticketsModal'), ticketsList=$('#ticketsList'), openCount=$('#openCount');
    const replyModal=$('#replyModal'), thread=$('#thread'), replyText=$('#replyText'), replyTicketId=$('#replyTicketId');
    const loginModal=$('#loginModal'); const logoutBtn=$('#logoutBtn');

    // ===== Firebase init =====
    const FB={enabled:false,app:null,db:null,auth:null,unsub:null};
    try{
      FB.app=firebase.initializeApp(firebaseConfig);
      FB.auth=firebase.auth();
      FB.db=firebase.firestore();
      FB.auth.signInAnonymously().then(()=>{FB.enabled=true; liveDot.style.background='#3ddc97'; modeLabel.textContent='Live'; subscribeTickets();})
        .catch(e=>{console.error(e); modeLabel.textContent='Offline';});
    }catch(e){ console.error('Firebase init failed', e); modeLabel.textContent='Offline'; }

    // ===== Local fallback KB =====
    const KB_DE=[{p:['hallo','hi','hey','moin','gr√º√ü'],r:'Hey! üëã Ich bin dein Chrombook-Helfer. Frag mich alles zu Chromebook, Linux, Apps & Leistung. ‚ú®'},
      {p:['tasten','shortcut','k√ºrzel','kombination'],r:'‚å®Ô∏è Shortcuts:\n‚Ä¢ Screenshot: Strg+‚ñ¢||\n‚Ä¢ Bereich: Strg+Umschalt+‚ñ¢||\n‚Ä¢ Tab neu/schlie√üen: Strg+T / Strg+W\n‚Ä¢ Task-Manager: Such + Esc üôÇ'},
      {p:['linux','crostini'],r:'üêß Linux: Einstellungen ‚Üí Entwickler ‚Üí Linux aktivieren. Dann: sudo apt update && sudo apt upgrade -y ‚Ä¢ sudo apt install git curl build-essential -y'},
      {p:['langsam','leistung','ruckelt','lag'],r:'‚ö° Schneller machen: Tabs/Erweiterungen pr√ºfen, Speicher aufr√§umen, Hardwarebeschleunigung aktivieren (Chrome ‚Üí System), Neustart/Powerwash als letzter Schritt.'},
      {p:['apps','play','android'],r:'üì± Apps: Einstellungen ‚Üí Apps ‚Üí Play-Store aktivieren ‚Üí im Store installieren. Viele Dienste auch als PWA verf√ºgbar. üõçÔ∏è'},
      {p:['druck','drucker','pdf'],r:'üñ®Ô∏è Drucken/PDF: Druck-Dialog ‚Üí ‚ÄûAls PDF speichern‚Äú oder Drucker unter Einstellungen ‚Üí ‚ÄûDrucker‚Äú hinzuf√ºgen. üìÑ'},
      {p:['hilfe','mitarbeiter','kontakt'],r:'ü§ù Wenn du pers√∂nliche Hilfe brauchst: Wechsel oben auf ‚Äûüë®‚Äçüíª Mitarbeiter‚Äú oder nutze ‚ÄûKontakt‚Äú. Wir sind da!'}];
    const KB_EN=[{p:['hello','hi','hey','yo','greetings'],r:'Hey! üëã I‚Äôm your Chromebook helper. Ask me anything about ChromeOS, Linux, apps and performance. ‚ú®'},
      {p:['keys','shortcut','shortcuts','hotkey','hotkeys'],r:'‚å®Ô∏è Shortcuts:\n‚Ä¢ Screenshot: Ctrl+Show windows (‚ñ¢||)\n‚Ä¢ Area screenshot: Ctrl+Shift+Show windows (‚ñ¢||)\n‚Ä¢ New/close tab: Ctrl+T / Ctrl+W\n‚Ä¢ Task manager: Search (üîç) + Esc üôÇ'},
      {p:['linux','crostini'],r:'üêß Linux: Settings ‚Üí Developers ‚Üí Linux development environment. Then: sudo apt update && sudo apt upgrade -y ‚Ä¢ sudo apt install git curl build-essential -y'},
      {p:['slow','lag','performance','stutter'],r:'‚ö° Speed up: review tabs/extensions, free storage, enable hardware acceleration (Chrome ‚Üí System), restart / Powerwash as a last resort.'},
      {p:['apps','play','android','pwa'],r:'üì± Apps: enable the Play Store in Settings ‚Üí Apps ‚Üí Google Play Store, or install PWAs from the web. üõçÔ∏è'},
      {p:['print','printer','pdf'],r:'üñ®Ô∏è Printing/PDF: use ‚ÄúSave as PDF‚Äù in the print dialog, or add printers under Settings ‚Üí Printing.'},
      {p:['help','human','support','contact'],r:'ü§ù Need personal help? Switch to ‚Äúüë®‚Äçüíª Support‚Äù above or use ‚ÄúSupport‚Äù. We‚Äôve got you!'}];
    function fallbackAnswer(q){ const KB=lang==='de'?KB_DE:KB_EN; const s=(q||'').toLowerCase(); for(const e of KB){ if(e.p.some(x=>s.includes(x))) return e.r+' ‚ú®'; } return lang==='de'?'Ich bin mir nicht sicher. ü§î‚û°Ô∏è Ich verweise dich an einen Mitarbeiter. Wechsle auf ‚Äûüë®‚Äçüíª Mitarbeiter‚Äú. üôå':'I‚Äôm not sure. ü§î‚û°Ô∏è I‚Äôll refer you to a human. Switch to ‚Äúüë®‚Äçüíª Support‚Äù. üôå'; }

    // ===== Always AI via PROXY_URL =====
    async function askAI(userText){
      const url = PROXY_URL || "";
      if(!url){ console.warn('No PROXY_URL set'); return null; }
      try{
        const history = botChat.slice(-8).map(m=>({role:m.role==='user'?'user':'assistant', content:m.text}));
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ prompt: userText, lang, history }) });
        if(!res.ok) throw new Error('proxy status '+res.status);
        const data = await res.json(); if(data && data.answer) return data.answer; return null;
      }catch(e){ console.warn('AI proxy failed', e); toast(I18N[lang].toast.aiFail); return null; }
    }

    // ===== Chat renderers =====
    function fmtTime(t){ return new Date(t).toLocaleString(I18N[lang].dateLocale,{year:'2-digit',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}); }
    function renderBotChat(){ const MY=I18N[lang].meYou||{user:(lang==='de'?'Du':'You'), bot:(lang==='de'?'Helfer':'Assistant')}; chatEl.innerHTML=''; for(const m of botChat){ const wrap=document.createElement('div'); wrap.className='msg '+(m.role==='user'?'user':'bot'); const avatar=document.createElement('div'); avatar.className='avatar'; avatar.textContent=m.role==='user'?'üë§':'ü§ñ'; const bubble=document.createElement('div'); bubble.className='bubble'; bubble.textContent=m.text; const meta=document.createElement('div'); meta.className='meta'; meta.textContent=(m.role==='user'?MY.user:MY.bot)+' ‚Ä¢ '+fmtTime(m.time); const col=document.createElement('div'); col.appendChild(bubble); col.appendChild(meta); wrap.appendChild(avatar); wrap.appendChild(col); chatEl.appendChild(wrap); } chatEl.scrollTop=chatEl.scrollHeight; save('cbh_bot_chat', botChat); }
    function renderStaffChat(){ chatEl.innerHTML=''; let t=tickets.find(x=>x.id===activeTicketId); if(!t){ const my=tickets.filter(x=>x.from===deviceId).sort((a,b)=>(b.time||0)-(a.time||0)); if(my[0]){ activeTicketId=my[0].id; save('cbh_active_ticket', activeTicketId); t=my[0]; } } if(!t){ chatEl.innerHTML='<div class="meta">'+(lang==='de'?'Kein aktiver Mitarbeiter-Chat. Starte einen Kontakt oben √ºber ‚ÄûKontakt‚Äú.':'No active support chat. Start one via ‚ÄúSupport‚Äù above.')+'</div>'; return; } const hdr=document.createElement('div'); hdr.className='meta'; hdr.textContent=(lang==='de'?'Chat mit Mitarbeiter ‚Ä¢ Ticket ':'Chat with Support ‚Ä¢ Ticket ')+t.id+(t.status==='erledigt'?(lang==='de'?' (erledigt)':' (resolved)'):''); chatEl.appendChild(hdr); const msgs=Array.isArray(t.messages)?t.messages:[]; for(const m of msgs){ const wrap=document.createElement('div'); wrap.className='msg '+(m.by==='user'?'user':'bot'); const avatar=document.createElement('div'); avatar.className='avatar'; avatar.textContent=m.by==='user'?'üë§':'üë®‚Äçüíª'; const bubble=document.createElement('div'); bubble.className='bubble'; bubble.textContent=m.text; const who=m.by==='user'?(lang==='de'?'Du':'You'):(lang==='de'?'Mitarbeiter':'Support'); const meta=document.createElement('div'); meta.className='meta'; meta.textContent=who+' ‚Ä¢ '+fmtTime(m.time); const col=document.createElement('div'); col.appendChild(bubble); col.appendChild(meta); wrap.appendChild(avatar); wrap.appendChild(col); chatEl.appendChild(wrap); } chatEl.scrollTop=chatEl.scrollHeight; }
    function renderChat(){ $('#tabBot').classList.toggle('active', mode==='bot'); $('#tabStaff').classList.toggle('active', mode==='staff'); if(mode==='bot'){ show($('#clearBotBtn')); } else { hide($('#clearBotBtn')); } if(mode==='bot') renderBotChat(); else renderStaffChat(); save('cbh_mode', mode); }

    // ===== Events & UI =====
    function applyTexts(){ const T=I18N[lang]; document.documentElement.lang=lang; $('#tabBot').textContent=T.tabs.bot; $('#tabStaff').textContent=T.tabs.staff; $('#contactBtn').textContent=T.contactBtn; $('#logoutBtn').textContent=T.logout; $('#input').placeholder=T.composerPH; $('#clearBotBtn').textContent=T.clearBot; $('#clearBotBtn').title=T.clearBot; $('#c1h').textContent=T.cards.c1h; $('#c1p').textContent=T.cards.c1p; $('#c1b').textContent=T.cards.c1b; $('#c2h').textContent=T.cards.c2h; $('#c2p').textContent=T.cards.c2p; $('#c2b').textContent=T.cards.c2b; $('#c3h').textContent=T.cards.c3h; $('#c3p').textContent=T.cards.c3p; $('#c3b').textContent=T.cards.c3b; $('#c4h').textContent=T.cards.c4h; $('#c4p').textContent=T.cards.c4p; $('#c4b').textContent=T.cards.c4b; }
    langBtn.addEventListener('click', ()=>{ lang=(lang==='de'?'en':'de'); save('cbh_lang',lang); applyTexts(); renderChat(); });
    $('#tabBot').addEventListener('click', ()=>{ mode='bot'; renderChat(); }); $('#tabStaff').addEventListener('click', ()=>{ mode='staff'; renderChat(); });
    $('#clearBotBtn').addEventListener('click', ()=>{ if(confirm(I18N[lang].confirmClear)){ botChat=[]; save('cbh_bot_chat', botChat); renderBotChat(); toast(lang==='de'?'Bot-Chat gel√∂scht ‚úÖ':'Bot chat cleared ‚úÖ'); } });

    // Contact flow
    function openContact(){ show(contactModal); $('#contactMsg').focus(); } function closeContact(){ hide(contactModal); }
    contactBtn.addEventListener('click', ()=>{ if(staff) openTickets(); else openContact(); });
    $('#cancelContact').addEventListener('click', closeContact);
    $('#sendContact').addEventListener('click', async ()=>{
      const msg=(contactMsg.value||'').trim(); if(!msg){ toast(I18N[lang].toast.needMsg); return; }
      if(!FB.enabled){ toast(I18N[lang].toast.offline); return; }
      const ref = await FB.db.collection('cbh_tickets').add({ from: deviceId, message: msg, time: Date.now(), status: 'offen', messages: [{by:'user', text: msg, time: Date.now()}]});
      activeTicketId = ref.id; save('cbh_active_ticket', activeTicketId);
      closeContact(); mode='staff'; renderChat(); toast(I18N[lang].toast.created);
    });

    // Tickets & Replies
    function openTickets(){ renderTickets(); show(ticketsModal); }
    $('#closeTickets').addEventListener('click', ()=> hide(ticketsModal) );
    $('#ticketsList').addEventListener('click', async (e)=>{
      const btn=e.target.closest('button[data-act]'); if(!btn) return;
      const id=btn.dataset.id; const act=btn.dataset.act;
      if(act==='resolve'){ await FB.db.collection('cbh_tickets').doc(id).update({status:'erledigt'}); }
      if(act==='delete'){ await FB.db.collection('cbh_tickets').doc(id).delete(); }
      if(act==='reply'){ activeTicketId=id; save('cbh_active_ticket', id); openReply(id); }
    });
    function renderTickets(){
      const T=I18N[lang]; const list=$('#ticketsList'); list.innerHTML='';
      if(tickets.length===0){ list.innerHTML='<p class="meta">'+T.tickets.none+'</p>'; return; }
      for(const t of tickets){
        const last=t.messages && t.messages.length ? t.messages[t.messages.length-1] : null;
        const preview = last ? (last.by==='staff'?'üë®‚Äçüíª ':'üë§ ') + escapeHTML(last.text).slice(0,80) : escapeHTML(t.message).slice(0,80);
        const el=document.createElement('div'); el.className='ticket';
        el.innerHTML=`<div><strong>Ticket:</strong> ${t.id} ‚Ä¢ <span class="tag">${t.status}</span></div>
          <div class="meta">${(lang==='de'?'Von: ':'From: ')+t.from} ‚Ä¢ ${fmt(t.time)}</div>
          <div style="margin:6px 0 8px; white-space:pre-wrap;">${preview}</div>
          <div class="rowbtn"><button data-act="reply" data-id="${t.id}">${T.tickets.open}</button><button data-act="resolve" data-id="${t.id}">${T.tickets.resolve}</button><button data-act="delete" data-id="${t.id}">${T.tickets.del}</button></div>`;
        list.appendChild(el);
      }
      const open = tickets.filter(t=>t.status==='offen').length; $('#openCount').textContent = ' ' + (lang==='de'?`(${open} offen)`: `(${open} open)`);
    }
    function openReply(id){ const t=tickets.find(x=>x.id===id); if(!t) return; $('#replyTicketId').textContent = '#'+t.id; renderThread(t); show(replyModal); }
    $('#replyBack').addEventListener('click', ()=>{ hide(replyModal); openTickets(); });
    $('#replyResolve').addEventListener('click', async ()=>{ const id=activeTicketId; if(!id) return; await FB.db.collection('cbh_tickets').doc(id).update({status:'erledigt'}); toast(lang==='de'?'Ticket erledigt ‚úÖ':'Ticket resolved ‚úÖ'); renderTickets(); hide(replyModal); });
    $('#sendReply').addEventListener('click', async ()=>{ const txt=($('#replyText').value||'').trim(); if(!txt){ toast(I18N[lang].toast.needReply); return; } await FB.db.collection('cbh_tickets').doc(activeTicketId).update({ messages: firebase.firestore.FieldValue.arrayUnion({ by:'staff', text: txt, time: Date.now() }) }); $('#replyText').value=''; });
    function renderThread(t){ const whoStaff=(lang==='de'?'Mitarbeiter':'Support'), whoUser=(lang==='de'?'Kunde':'Customer'); const box=$('#thread'); box.innerHTML=''; const msgs=Array.isArray(t.messages)?t.messages:[]; for(const m of msgs){ const d=document.createElement('div'); d.className='tmsg '+(m.by==='staff'?'right':''); d.innerHTML=`<div class="who">${m.by==='staff'?whoStaff:whoUser}</div><div class="txt">${escapeHTML(m.text)}<div class="meta">${fmtTime(m.time)}</div></div>`; box.appendChild(d); } box.scrollTop=box.scrollHeight; }
    function escapeHTML(s){ return (s||'').replace(/[&<>]/g, t => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[t])); }

    // Realtime
    function subscribeTickets(){
      if(FB.unsub){ try{FB.unsub()}catch{} FB.unsub=null; }
      const q = staff ? FB.db.collection('cbh_tickets').orderBy('time','desc').limit(200) : FB.db.collection('cbh_tickets').where('from','==',deviceId);
      FB.unsub = q.onSnapshot(async (snap)=>{
        const arr=[]; const mig=[];
        snap.forEach(doc=>{ const d=doc.data()||{}; const n={ id:doc.id, from:d.from, time:d.time||0, status:d.status||'offen', message:d.message||'', messages: Array.isArray(d.messages)? d.messages: [] };
          if(!Array.isArray(d.messages) && d.message){ n.messages=[{by:'user', text:d.message, time:d.time||Date.now()}]; mig.push({id:doc.id, n}); }
          arr.push(n);
        });
        tickets=arr; for(const m of mig){ try{ await FB.db.collection('cbh_tickets').doc(m.id).update({ messages: m.n.messages }); }catch{} }
        if(mode==='staff') renderStaffChat(); if(staff) renderTickets();
      }, (err)=>{ console.error('snapshot error', err); modeLabel.textContent='Error'; liveDot.style.background='#666'; });
    }

    // Secret login
    function openLogin(){ show(loginModal); hide($('#step2')); hide($('#step3')); show($('#step1')); setTimeout(()=>$('#code1').focus(), 50); }
    function closeLogin(){ hide(loginModal); }
    window.addEventListener('keydown', (e)=>{ const isHash = e.key === '#' || e.code === 'Backslash' || (e.code==='Digit3' && (e.altKey||e.ctrlKey)); if(e.ctrlKey && e.altKey && isHash){ e.preventDefault(); openLogin(); } if(e.key==='Escape'){ hide(contactModal); hide(loginModal); hide(ticketsModal); hide(replyModal); } });
    $('#cancelLogin').addEventListener('click', closeLogin);
    $('#next1').addEventListener('click', ()=>{ if($('#code1').value.trim()==='140318'){ hide($('#step1')); show($('#step2')); $('#email').focus(); } else toast(I18N[lang].toast.wrongCode); });
    $('#next2').addEventListener('click', ()=>{ if(($('#email').value||'').trim().toLowerCase()==='julian1339klausch@gmx.de'){ hide($('#step2')); show($('#step3')); $('#code2').focus(); } else toast(I18N[lang].toast.wrongEmail); });
    $('#back1').addEventListener('click', ()=>{ hide($('#step2')); show($('#step1')); });
    $('#back2').addEventListener('click', ()=>{ hide($('#step3')); show($('#step2')); });
    $('#finishLogin').addEventListener('click', ()=>{ if($('#code2').value.trim()==='11.09.2000'){ sessionStorage.setItem('cbh_staff','1'); staff=true; applyStaffUI(); toast(I18N[lang].toast.loggedIn); closeLogin(); subscribeTickets(); } else toast(I18N[lang].toast.wrongCode2); });
    $('#logoutBtn').addEventListener('click', ()=>{ staff=false; sessionStorage.removeItem('cbh_staff'); applyStaffUI(); toast(lang==='de'?'Abgemeldet.':'Signed out.'); subscribeTickets(); });

    // Composer (AI first)
    document.querySelector('#composer').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const val=(input.value||'').trim(); if(!val) return;
      if(val === '/login'){ openLogin(); input.value=''; return; }
      if(val === '/en'){ lang='en'; save('cbh_lang',lang); applyTexts(); renderChat(); input.value=''; return; }
      if(val === '/de'){ lang='de'; save('cbh_lang',lang); applyTexts(); renderChat(); input.value=''; return; }

      if(mode==='bot'){
        botChat.push({role:'user', text: val, time: Date.now()}); renderBotChat();
        let answer = await askAI(val); if(!answer){ answer = fallbackAnswer(val); }
        botChat.push({role:'bot', text: answer, time: Date.now()}); renderBotChat();
      }else{
        if(!FB.enabled){ toast(I18N[lang].toast.offline); input.value=''; return; }
        try{
          if(!activeTicketId){
            const ref = await FB.db.collection('cbh_tickets').add({ from: deviceId, message: val, time: Date.now(), status: 'offen', messages: [{by:'user', text: val, time: Date.now()}]});
            activeTicketId = ref.id; save('cbh_active_ticket', activeTicketId);
          }else{
            await FB.db.collection('cbh_tickets').doc(activeTicketId).update({ messages: firebase.firestore.FieldValue.arrayUnion({by:'user', text: val, time: Date.now()}) });
          }
        }catch(e){ console.error(e); toast(I18N[lang].toast.offline); }
      }
      input.value='';
    });

    function applyStaffUI(){ if(staff){ $('#contactBtn').textContent=(lang==='de'?'Chat-Center':'Chat center'); $('#contactBtn').title=(lang==='de'?'Chat-Center √∂ffnen':'Open chat center'); show($('.fab')); show($('#logoutBtn')); } else { $('#contactBtn').textContent=I18N[lang].contactBtn; $('#contactBtn').title=(lang==='de'?'Mitarbeiter kontaktieren':'Contact support'); hide($('.fab')); hide($('#logoutBtn')); } }

    // First run greet
    if(!load('cbh_seen_v12p', false)){ const greet = I18N[lang].firstRun; botChat.push({role:'bot', text:greet, time: Date.now()}); save('cbh_seen_v12p', true); }

    // Kick-off
    applyTexts(); applyStaffUI(); renderChat(); subscribeTickets();
  });
  </script>
</body>
</html>
